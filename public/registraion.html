<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSI Student Registration</title>
  <link rel="stylesheet" href="Css/reg.css">
</head>
<body>
  <!-- Header Section -->
  <header class="header">
    <div class="logo-section">
      <div class="logo-placeholder">CSI</div>
      <h1 class="page-title">Student Registration</h1>
      <p class="page-subtitle">Join the Computer Society of India - Your Gateway to Tech Excellence</p>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="form-container">
      <!-- Personal Information Section -->
      <section class="form-section">
        <h2 class="section-title">Personal Information</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" placeholder="Enter your complete name" required>
          </div>
          
          <div class="form-group">
            <label for="mobile">Mobile Number</label>
            <input type="tel" id="mobile" placeholder="10-digit mobile number" pattern="[0-9]{10}" required>
          </div>
          <div class="form-group">
  <label for="email">Email Address</label>
  <input type="email" id="email" placeholder="Enter your email" required>
</div>

        </div>
      </section>

      <section class="form-section">
        <h2 class="section-title">Academic Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="year">Academic Year</label>
            <select id="year" required>
              <option value="">Select your current year</option>
              <option value="1">1st Year</option>
              <option value="2">2nd Year</option>
              <option value="3">3rd Year</option>
              <option value="4">4th Year</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="branch">Branch/Specialization</label>
            <input type="text" id="branch" placeholder="e.g., Computer Science Engineering" required>
          </div>
        </div>
      </section>

      <!-- Registration Details Section -->
      <section class="form-section">
        <h2 class="section-title">Registration Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="amount">Registration Amount</label>
            <input type="number" id="amount" placeholder="Amount paid in â‚¹" required min="0">
          </div>
          
          <div class="form-group">
            <label for="img">Profile Picture</label>
            <input type="file" id="img" name="img" accept="image/*" capture="environment" required>
          </div>
        </div>

        <!-- Status Selection -->
        <div class="radio-section">
          <h3 class="section-title">Registration Status</h3>
          <div class="radio-group">
            <div class="radio-option selected" data-value="interested">
              <input type="radio" id="interested" name="status" value="interested" checked>
              <label for="interested">Interested</label>
            </div>
            <div class="radio-option" data-value="registered">
              <input type="radio" id="registered" name="status" value="registered">
              <label for="registered">Registered</label>
            </div>
          </div>
        </div>
      </section>

      <!-- Submit Section -->
      <section class="submit-section">
        <button id="submitBtn">
          <span class="btn-text">Complete Registration</span>
        </button>
      </section>
    </div>
  </main>

  <!-- Modal popup -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div id="modalIcon"></div>
      <h3 id="modalTitle">Success!</h3>
      <p id="modalMsg">Your registration has been submitted successfully.</p>
      <button id="modalClose">Continue</button>
    </div>
  </div>

  <script>
    // Grab elements
    const btn = document.getElementById('submitBtn');
    const btnText = document.querySelector('.btn-text');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const modalIcon = document.getElementById('modalIcon');
    const modalClose = document.getElementById('modalClose');

    // Radio button selection handling
    document.querySelectorAll('.radio-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        const radio = option.querySelector('input[type="radio"]');
        radio.checked = true;
      });
    });

    // Form validation
    function validateForm() {
      let isValid = true;
      const fields = ['name', 'year', 'branch', 'amount', 'mobile'];
      
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const formGroup = field.closest('.form-group');
        
        if (!field.value.trim()) {
          formGroup.classList.add('error');
          isValid = false;
        } else {
          formGroup.classList.remove('error');
        }
      });

      const mobile = document.getElementById('mobile').value.trim();
      if (mobile && !/^\d{10}$/.test(mobile)) {
        document.getElementById('mobile').closest('.form-group').classList.add('error');
        isValid = false;
      }

      const fileInput = document.getElementById('img');
      if (!fileInput.files.length) {
        fileInput.closest('.form-group').classList.add('error');
        isValid = false;
      }

      return isValid;
    }

    function showModal(title = 'Success!', msg = '', isSuccess = true) {
      modalTitle.textContent = title;
      modalMsg.textContent = msg;
      
      if (isSuccess) {
        modalIcon.innerHTML = '<div class="success-icon">âœ“</div>';
      } else {
        modalIcon.innerHTML = '<div class="success-icon" style="background: #e53e3e;">âœ—</div>';
      }
      
      modalOverlay.classList.add('show');
    }

    function hideModal() {
      modalOverlay.classList.remove('show');
    }

    modalClose.addEventListener('click', hideModal);
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) hideModal();
    });

    // Remove error styling on input
    document.querySelectorAll('input, select').forEach(field => {
      field.addEventListener('input', () => {
        field.closest('.form-group').classList.remove('error');
      });
    });

    // Smooth scrolling for form sections on mobile
    if (window.innerWidth <= 768) {
      document.querySelectorAll('input, select').forEach(field => {
        field.addEventListener('focus', () => {
          setTimeout(() => {
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    }

    btn.addEventListener('click', async function () {
      // Validate form
      if (!validateForm()) {
        showModal('Validation Error', 'Please fill in all required fields correctly and ensure your mobile number is 10 digits.', false);
        
        // Scroll to first error
        const firstError = document.querySelector('.form-group.error');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      // Get form data
      const name = document.getElementById('name').value.trim();
      const year = document.getElementById('year').value;
      const branch = document.getElementById('branch').value.trim();
      const amount = document.getElementById('amount').value;
      const mobile = document.getElementById('mobile').value.trim();
      const email= document.getElementById('email').value.trim();
      const fileInput = document.getElementById('img');
      const statusEl = document.querySelector('input[name="status"]:checked');
      const option = statusEl ? statusEl.value : 'interested';

      // Show loading state
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span>Processing Registration...';

      // Build FormData
      const fd = new FormData();
      fd.append('studentName', name);
      fd.append('year', year);
      fd.append('branch', branch);
      fd.append('amountPaid', amount);
      fd.append('mobileNumber', mobile);
      fd.append("email",email)
      fd.append('img', fileInput.files[0]);

      try {
        const res = await fetch(`https://csi-uyhe.onrender.com/studentdetails?option=${option}`, {
          method: 'POST',
          body: fd
        });

        if (!res.ok) {
          const text = await res.text().catch(() => null);
          console.error('Server error:', res.status, text);
          showModal('Submission Failed', text || `Server error (${res.status}). Please try again later.`, false);
          return;
        }

        const text = await res.text().catch(() => 'Registration completed successfully!');
        showModal('Registration Complete!', 'Welcome to CSI! Your registration has been processed successfully. You will receive further updates on your mobile number.', true);

        // Reset form
        document.getElementById('name').value = '';
        document.getElementById('year').value = '';
        document.getElementById('branch').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('mobile').value = '';
        document.getElementById('email').value = '';

        fileInput.value = '';
        document.getElementById('interested').checked = true;
        document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        document.querySelector('[data-value="interested"]').classList.add('selected');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (err) {
        console.error('Network error:', err);
        showModal('Network Error', 'Unable to connect to server. Please check your internet connection and try again.', false);
      } finally {
        btn.disabled = false;
        btnText.innerHTML = 'Complete Registration';
      }
    });

    // Add entrance animations on scroll for better UX
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.animation = 'slideUp 0.6s ease-out forwards';
        }
      });
    }, observerOptions);

    document.querySelectorAll('.form-section').forEach(section => {
      observer.observe(section);
    });
  </script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // --- Room Setup ---
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  const roomId = getCookie("id") || getQueryParam("id");
  if (roomId) {
    socket.emit("joinRoom", { room: roomId });
    console.log(`ðŸ“¡ Joined room: ${roomId}`);
  } else {
    console.warn("No room id found in cookies or URL");
  }

  // --- Form Fields ---
  const nameInput = document.getElementById('name');
  const yearInput = document.getElementById('year');
  const branchInput = document.getElementById('branch');
  const mobileInput = document.getElementById('mobile');
  const amountInput = document.getElementById('amount');
  const emailInput = document.getElementById('email'); // New field
  const imgInput = document.getElementById('img');

  // --- Real-Time Emit Helper ---
  function emitField(eventName, value) {
    if (roomId) {
      socket.emit(eventName, { room: roomId, [eventName]: value });
      console.log(`ðŸ“¤ Emitted ${eventName}:`, value);
    }
  }

  // --- Emit on Input/Change ---
  nameInput.addEventListener('input', () => emitField("studentName", nameInput.value));
  yearInput.addEventListener('change', () => emitField("year", yearInput.value));
  branchInput.addEventListener('input', () => emitField("branch", branchInput.value));
  mobileInput.addEventListener('input', () => emitField("mobileNumber", mobileInput.value));
  amountInput.addEventListener('input', () => emitField("amountPaid", amountInput.value));
  emailInput.addEventListener('input', () => emitField("email", emailInput.value)); 

  // --- Emit Image as Base64 ---
  imgInput.addEventListener('change', () => {
    const file = imgInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function () {
      const base64Img = reader.result.split(',')[1]; 
      if (roomId) {
        socket.emit("img", { room: roomId, img: base64Img });
        console.log("ðŸ“¤ Emitted image as base64");
      }
    };
    reader.readAsDataURL(file);
  });

  // --- Optional: Private Message Signal ---
  function sendPrivateMessage() {
    if (roomId) {
      socket.emit("privatemessage", { roomId: roomId, bool: true });
      console.log("ðŸ“© Private message sent");
    }
  }
</script>


</body>
</html>